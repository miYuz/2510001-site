<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âè∞ÊåáÊúüË∂®Âã¢ËøΩËπ§Á≠ñÁï•</title>
    
    <!-- 1. Ê†∏ÂøÉÂ•ó‰ª∂ CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/react-plotly.js@2.6.0/dist/create-plotly-component.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 2. Google AI SDK Import Map -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        /* 3. CSS Ê®£Âºè (Á∂≠ÊåÅÂ•∂Ê≤πË≥™ÊÑü) */
        :root {
            --bg-color: #F7F5F2; --card-bg: #FFFFFF; --text-color: #4A4A4A; --text-sub: #8C8C8C;
            --portfolio-color: #D69E2E; --benchmark-color: #2D3748; --positive-color: #38A169;
            --negative-color: #E53E3E; --safe-line-color: #E53E3E; --input-bg: #F8FAFC;
            --border-color: #E2E8F0; --ai-bubble-bg: #F0F4F8; --user-bubble-bg: #FEFCBF;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px; }
        header h2 { font-size: 1.5rem; margin: 0; font-weight: 700; color: var(--benchmark-color); letter-spacing: 0.5px; }
        .status-badge { background-color: #C6F6D5; color: #22543D; padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; cursor: default; user-select: none; }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .tab-btn { padding: 12px 20px; background: transparent; border: none; color: var(--text-sub); font-size: 1rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 500; flex-shrink: 0; }
        .tab-btn:hover { color: var(--portfolio-color); }
        .tab-btn.active { color: var(--portfolio-color); border-bottom-color: var(--portfolio-color); font-weight: 700; }
        .tab-content { animation: fadeIn 0.4s ease; }
        .control-panel { background-color: var(--card-bg); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid var(--border-color); }
        .control-row { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
        .control-row:last-child { margin-bottom: 0; }
        .section-title { font-size: 0.95em; color: var(--portfolio-color); font-weight: 700; width: 100%; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 100px; }
        .input-group label { font-size: 0.85em; color: var(--text-sub); font-weight: 500; }
        .input-group input, .input-group select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px 12px; border-radius: 8px; width: 100%; text-align: center; font-size: 1em; font-weight: 600; box-sizing: border-box; }
        .input-group input:focus { outline: none; border-color: var(--portfolio-color); background: #FFF; }
        .input-group.checkbox-group { flex-direction: row; align-items: center; gap: 12px; flex: 1 0 100%; background: #FFFAF0; padding: 12px 15px; border-radius: 8px; border: 1px solid #FEEBC8; }
        .input-group.checkbox-group input { width: 20px; height: 20px; cursor: pointer; }
        .input-group.checkbox-group label { font-size: 1em; color: #744210; margin: 0; cursor: pointer; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background-color: var(--card-bg); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid var(--border-color); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .card h3 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--text-sub); font-weight: 500; }
        .card .value { font-size: 1.5em; font-weight: 700; margin: 5px 0; color: var(--text-color); }
        .card .sub { font-size: 0.8em; color: var(--text-sub); margin-top: 4px; }
        .value.negative { color: var(--negative-color); }
        .chart-box, .info-card { background-color: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid var(--border-color); overflow: hidden; }
        .chart-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .time-filters { display: flex; gap: 5px; background: #EDF2F7; padding: 4px; border-radius: 8px; overflow-x: auto; }
        .tf-btn { background: transparent; border: none; color: #718096; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; white-space: nowrap; transition: all 0.2s; }
        .tf-btn:hover { background-color: rgba(255,255,255,0.5); }
        .tf-btn.active { background: #FFFFFF; color: var(--portfolio-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-container { background-color: var(--card-bg); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid var(--border-color); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; min-width: 600px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #EDF2F7; color: var(--text-sub); font-weight: 600; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #EDF2F7; color: var(--text-color); white-space: nowrap; }
        .td-num { text-align: right; font-family: monospace; font-weight: 500; }
        .rank-badge { background: var(--input-bg); color: var(--text-sub); padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 700; border: 1px solid var(--border-color); }
        
        /* Info */
        .info-card-header { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .strat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em; }
        .bg-kama { background: linear-gradient(135deg, #F5C518, #D69E2E); }
        .bg-ceo { background: linear-gradient(135deg, #58A6FF, #2D3748); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .info-section h4 { color: var(--portfolio-color); margin: 0 0 12px 0; border-left: 4px solid var(--portfolio-color); padding-left: 10px; }
        .info-list { list-style: none; padding: 0; }
        .info-list li { position: relative; padding-left: 20px; margin-bottom: 10px; }
        .info-list li::before { content: '‚Ä¢'; color: var(--text-sub); position: absolute; left: 0; }
        .logic-box { background: var(--input-bg); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; border: 1px solid var(--border-color); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 4. React Á®ãÂºèÁ¢º (JSX) -->
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        const Plot = createPlotlyComponent(Plotly);

        // GitHub Pages ÊúÉËá™ÂãïËÆÄÂèñÂêåÁõÆÈåÑ‰∏ãÁöÑÊ≠§Ê™îÊ°à
        const DEFAULT_LOCAL_FILE = 'txf_result.csv';

        const COLORS = {
            portfolio: '#D69E2E',
            benchmark: '#2D3748',
            positive: '#38A169',
            negative: '#E53E3E',
            safeLine: '#E53E3E',
            bg: '#F7F5F2',
            text: '#4A4A4A',
            subText: '#8C8C8C'
        };

        // --- SVGs Icons ---
        const UploadIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const KamaIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>;
        const CeoIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return d.getUTCFullYear() + "-" + weekNo;
        };

        function App() {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('sim');
            
            const [config, setConfig] = useState({
                initCapital: 1000000,
                multiplier: 50,
                useFixedLev: false,
                targetLev: 6,
                safeFactor: 10,
                w_ceo_l: 4,
                w_ceo_s: 2,
                w_kama: 1,
                w_bench: 4,
                timeRange: 'ALL'
            });

            const loadData = async (source, type) => {
                setLoading(true);
                setError(null);
                try {
                    let data;
                    const cacheBuster = '?t=' + new Date().getTime();
                    if (type === 'upload') {
                        const text = await source.text();
                        data = d3.csvParse(text);
                    } else {
                        // GitHub Pages / Local load
                        data = await d3.csv(source + cacheBuster);
                    }

                    if (!data || data.length === 0) throw new Error("CSV ÁÇ∫Á©∫ÊàñÊ†ºÂºèÈåØË™§");
                    
                    const cleanData = data.map(row => {
                        let newRow = {};
                        for (let k in row) {
                            let cleanKey = k.trim().replace(/^\ufeff/, '');
                            newRow[cleanKey] = row[k]; 
                        }
                        return newRow;
                    });
                    setRawData(cleanData);
                } catch (err) {
                    console.error(err);
                    setError(err.message + " (Ë´ãÁ¢∫Ë™ç txf_result.csv Â∑≤‰∏äÂÇ≥‰∏îËàá index.html Âú®Âêå‰∏ÄÁõÆÈåÑ)");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(DEFAULT_LOCAL_FILE, 'local'); }, []);

            const filterDataByRange = (data, range) => {
                if(range === 'ALL' || !data.length) return data;
                const lastDate = new Date(data[data.length-1].ts);
                let startDate = new Date(lastDate);
                switch(range) {
                    case 'YTD': startDate = new Date(lastDate.getFullYear(), 0, 1); break;
                    case '6M': startDate.setMonth(startDate.getMonth()-6); break;
                    case '1Y': startDate.setFullYear(startDate.getFullYear()-1); break;
                    case '2Y': startDate.setFullYear(startDate.getFullYear()-2); break;
                    case '3Y': startDate.setFullYear(startDate.getFullYear()-3); break;
                }
                return data.filter(d => new Date(d.ts) >= startDate);
            };

            const simulationResults = useMemo(() => {
                if (rawData.length === 0) return null;
                const simData = filterDataByRange(rawData, config.timeRange);
                if (simData.length === 0) return null;

                const times = simData.map(d => d.ts);
                let benchKey = simData[0].hasOwnProperty('TXF_caa') ? 'TXF_caa' : (simData[0].hasOwnProperty('TXF_abs') ? 'TXF_abs' : null);

                let currPort = config.initCapital, currBench = config.initCapital, maxEq = config.initCapital;
                let w1=config.w_kama, w2=config.w_ceo_l, w3=config.w_ceo_s, w_bench=config.w_bench;
                const baseSum = w1+w2+w3;
                let lastWeek = -1;
                let prevBenchPrice = benchKey ? (parseFloat(simData[0][benchKey])||0) : 0;

                const portCurve=[], benchCurve=[], highCurve=[], levCurve=[], safeCurve=[];
                const dailyPnL={}, dateKeyOrder=[], quarterly={};

                simData.forEach((row, i) => {
                    const date = new Date(row.ts);
                    const price = benchKey ? (parseFloat(row[benchKey])||0) : 0;

                    if (config.useFixedLev && !isNaN(date.getTime())) {
                        const week = getWeekNumber(date);
                        if (week !== lastWeek || i===0) {
                            lastWeek = week;
                            if (price > 0) {
                                if (baseSum > 0) {
                                    const targetExp = currPort * config.targetLev;
                                    const k = Math.max(1, Math.round((targetExp / (price*config.multiplier)) / baseSum));
                                    w1=config.w_kama*k; w2=config.w_ceo_l*k; w3=config.w_ceo_s*k;
                                }
                                const benchExp = currPort * config.targetLev; 
                                const targetB = Math.max(1, Math.round(benchExp / (price*config.multiplier)));
                                w_bench = targetB;
                            }
                        }
                    } else if (!config.useFixedLev) {
                        w_bench = config.w_bench; w1=config.w_kama; w2=config.w_ceo_l; w3=config.w_ceo_s;
                    }

                    const p1 = (parseFloat(row.kama_L)||0)*w1;
                    const p2 = (parseFloat(row.ceo_L)||0)*w2;
                    const p3 = (parseFloat(row.ceo_S)||0)*w3;
                    const moneyPnL = (p1+p2+p3) * config.multiplier;

                    let benchMoneyPnL = 0;
                    if (i > 0) {
                        const priceDelta = price - prevBenchPrice;
                        benchMoneyPnL = priceDelta * w_bench * config.multiplier;
                    }
                    prevBenchPrice = price;

                    currPort += moneyPnL; currBench += benchMoneyPnL;
                    if (currPort > maxEq) maxEq = currPort;

                    portCurve.push(currPort); benchCurve.push(currBench); highCurve.push(maxEq);
                    
                    const contracts = Math.abs(w1)+Math.abs(w2)+Math.abs(w3);
                    levCurve.push(currPort>0 ? (price*contracts*config.multiplier)/currPort : 0);
                    
                    const maxSide = Math.max(Math.abs(w1)+Math.abs(w2), Math.abs(w3));
                    safeCurve.push((maxSide * price * config.multiplier) / config.safeFactor);

                    const dateStr = row.ts.split(' ')[0];
                    if (!dailyPnL[dateStr]) { dailyPnL[dateStr]=0; dateKeyOrder.push(dateStr); }
                    dailyPnL[dateStr] += moneyPnL;

                    if(!isNaN(date)) {
                        const k = `${date.getFullYear()}-Q${Math.floor(date.getMonth()/3)+1}`;
                        if(!quarterly[k]) quarterly[k] = {p:0, b:0};
                        quarterly[k].p += moneyPnL; quarterly[k].b += benchMoneyPnL;
                    }
                });

                let peak=portCurve[0], dds=[], currDD=null;
                portCurve.forEach((v,i) => {
                    if(v>=peak) { if(currDD){currDD.end=i; dds.push(currDD); currDD=null;} peak=v; }
                    else {
                        const d = v-peak;
                        if(!currDD) currDD={s:i, v:i, m:d, end:-1};
                        else if(d<currDD.m) { currDD.m=d; currDD.v=i; }
                    }
                });
                if(currDD) dds.push(currDD);
                dds.sort((a,b)=>a.m - b.m);
                const mddMoney = dds.length>0 ? dds[0].m : 0;

                let dailyReturns = [], tempEq = config.initCapital;
                dateKeyOrder.forEach(d => {
                    const r = tempEq>0 ? dailyPnL[d]/tempEq : 0;
                    dailyReturns.push(r);
                    tempEq += dailyPnL[d];
                });
                const meanRet = dailyReturns.reduce((a,b)=>a+b,0)/dailyReturns.length;
                const stdRet = Math.sqrt(dailyReturns.reduce((a,b)=>a+Math.pow(b-meanRet,2),0)/dailyReturns.length);
                const sharpe = stdRet>0 ? (meanRet/stdRet)*Math.sqrt(252) : 0;
                
                const downDev = Math.sqrt(dailyReturns.reduce((a,b)=>a+(b<0?Math.pow(b,2):0),0)/dailyReturns.length);
                const sortino = downDev>0 ? (meanRet/downDev)*Math.sqrt(252) : 0;

                return {
                    times, portCurve, benchCurve, highCurve, levCurve, safeCurve, quarterly, 
                    dds: dds.slice(0,10).map(d=>({
                        start: times[d.s].split(' ')[0], 
                        valley: times[d.v].split(' ')[0],
                        end: d.end!==-1?times[d.end].split(' ')[0]:'Open',
                        loss: d.m
                    })),
                    stats: {
                        final: currPort, profit: currPort-config.initCapital, 
                        mdd: mddMoney, sharpe, sortino, benchFinal: currBench
                    },
                    benchKey
                };
            }, [rawData, config]);

            const monitorResults = useMemo(() => {
                if (rawData.length === 0) return null;
                const monData = filterDataByRange(rawData, config.timeRange);
                if (monData.length === 0) return null;
                const times = monData.map(d=>d.ts);
                const res = {};
                ['kama_L','ceo_L','ceo_S'].forEach(s => {
                    if(!monData[0][s]) return;
                    const pnl = monData.map(d=>parseFloat(d[s])||0);
                    const cum = []; pnl.reduce((a,b,i)=>cum[i]=a+b,0);
                    let max= -Infinity;
                    const dd = cum.map(v=>{ if(v>max)max=v; return v-max; });
                    res[s] = {cum, dd, tot: cum[cum.length-1], mdd: Math.min(...dd)};
                });
                return {times, res};
            }, [rawData, config.timeRange]);

            const setTimeRange = (period, btn, page) => {
                const containerId = page === 'sim' ? 'sim-filters' : 'monitor-filters';
                const container = document.getElementById(containerId);
                container.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                setConfig({...config, timeRange: period});
            };

            return (
                <div className="container">
                    <header>
                        <div><h2>üìä Âè∞ÊåáÊúüË∂®Âã¢ËøΩËπ§ Web App</h2><div style={{fontSize:'0.85em',color:COLORS.subText}}>SPA ‚Ä¢ React</div></div>
                        <div style={{display:'flex',gap:10}}>
                            <label className="status-badge" style={{background:COLORS.inputBg, border:`1px solid ${COLORS.border}`, color:COLORS.text, cursor:'pointer'}}>
                                <UploadIcon/><span style={{marginLeft:5}}>‰∏äÂÇ≥ CSV</span>
                                <input type="file" accept=".csv" style={{display:'none'}} onChange={e=>e.target.files[0] && loadData(e.target.files[0], 'upload')}/>
                            </label>
                            <span className="status-badge">{loading?'Loading...':`Data: ${rawData.length}`}</span>
                        </div>
                    </header>

                    {error && <div style={{background:'#FED7D7', color:'#C53030', padding:15, borderRadius:8, marginBottom:20}}><strong>‚ö†Ô∏è Error:</strong> {error}</div>}

                    <div className="tabs">
                        {[{id:'sim',l:'üõ†Ô∏è Ê®°Êì¨'},{id:'monitor',l:'üìà Áõ£Êéß'},{id:'intro',l:'üìò ‰ªãÁ¥π'}].map(t=><button key={t.id} className={`tab-btn ${activeTab===t.id?'active':''}`} onClick={()=>setActiveTab(t.id)}>{t.l}</button>)}
                    </div>

                    <div className="tab-content">
                        {activeTab==='sim' && simulationResults && (
                            <>
                                <div className="control-panel">
                                    <div className="control-row">
                                        <div className="input-group"><label>ÂàùÂßãË≥áÈáë</label><input type="number" value={config.initCapital} step={10000} onChange={e=>setConfig({...config,initCapital:parseFloat(e.target.value)})}/></div>
                                        <div className="input-group"><label>ÂïÜÂìÅ</label><select value={config.multiplier} onChange={e=>setConfig({...config,multiplier:parseFloat(e.target.value)})}>
                                            <option value={50}>MTX (50)</option><option value={200}>TX (200)</option></select></div>
                                        <div className="input-group checkbox-group"><input type="checkbox" checked={config.useFixedLev} onChange={e=>setConfig({...config,useFixedLev:e.target.checked})}/><label>Âõ∫ÂÆöÊßìÊ°ø</label></div>
                                        <div className="input-group"><label>ÊßìÊ°øÂÄçÊï∏</label><input type="number" value={config.targetLev} step={0.5} onChange={e=>setConfig({...config,targetLev:parseFloat(e.target.value)})}/></div>
                                        <div className="input-group"><label>ÂÆâÂÖ®‰øÇÊï∏ (1/x)</label><input type="number" value={config.safeFactor} step={0.5} onChange={e=>setConfig({...config,safeFactor:parseFloat(e.target.value)})}/></div>
                                    </div>
                                    <div className="control-row">
                                        <div className="input-group"><label>ceo_L</label><input type="number" value={config.w_ceo_l} onChange={e=>setConfig({...config,w_ceo_l:parseFloat(e.target.value)})}/></div>
                                        <div className="input-group"><label>ceo_S</label><input type="number" value={config.w_ceo_s} onChange={e=>setConfig({...config,w_ceo_s:parseFloat(e.target.value)})}/></div>
                                        <div className="input-group"><label>kama_L</label><input type="number" value={config.w_kama} onChange={e=>setConfig({...config,w_kama:parseFloat(e.target.value)})}/></div>
                                        <div className="input-group"><label>Bench</label><input type="number" value={config.w_bench} onChange={e=>setConfig({...config,w_bench:parseFloat(e.target.value)})}/></div>
                                    </div>
                                </div>

                                <div className="grid-stats">
                                    <StatsCard title="Ê∑®ÂÄº" value={`$${Math.round(simulationResults.stats.final/10000)}Ëê¨`} sub={`+$${Math.round(simulationResults.stats.profit).toLocaleString()}`} color={COLORS.portfolio}/>
                                    <StatsCard title="MDD" value={`$${Math.round(simulationResults.stats.mdd/10000)}Ëê¨`} sub="Risk" color={COLORS.negative} isNegative/>
                                    <StatsCard title="Sharpe" value={simulationResults.stats.sharpe.toFixed(2)} sub={`Sortino: ${simulationResults.stats.sortino.toFixed(2)}`} color="#9C27B0"/>
                                    <StatsCard title="Bench" value={`$${Math.round(simulationResults.stats.benchFinal/10000)}Ëê¨`} sub={config.useFixedLev?`Lev ${config.targetLev}x`:`${config.w_bench}Âè£`} color={COLORS.benchmark}/>
                                </div>

                                <div className="chart-box">
                                    <div className="chart-header-row"><h3 style={{margin:0,color:COLORS.text}}>Ê¨äÁõäÊõ≤Á∑ö (Âê´ÂÆâÂÖ®Á∑ö)</h3>
                                        <div className="time-filters" id="sim-filters">{['6M','YTD','1Y','2Y','3Y','ALL'].map(p=><button key={p} className={`tf-btn ${config.timeRange===p?'active':''}`} onClick={(e)=>setTimeRange(p, e.target, 'sim')}>{p}</button>)}</div>
                                    </div>
                                    <EquityChart data={simulationResults} height={450} config={config}/>
                                </div>
                                <div className="chart-box"><h3 style={{margin:0, marginBottom:10, color:COLORS.text}}>ÊßìÊ°øËÆäÂåñ</h3><LeverageChart data={simulationResults} height={250} config={config}/></div>
                                <div className="table-container"><h3 style={{marginTop:0, marginBottom:15, color:COLORS.text}}>Top 10 Drawdowns</h3><DrawdownTable data={simulationResults.dds}/></div>
                                <div className="chart-box"><h3 style={{margin:0, marginBottom:15, color:COLORS.text}}>Â≠£Â∫¶Á∏æÊïà</h3><QuarterlyChart data={simulationResults.quarterly}/></div>
                            </>
                        )}

                        {activeTab === 'monitor' && monitorResults && (
                            <>
                                <div className="chart-box" style={{marginBottom:15, padding:10}}>
                                    <div className="chart-header-row" style={{marginBottom:0}}>
                                        <h3 style={{margin:0, color:COLORS.text}}>ÂçÄÈñìÁØ©ÈÅ∏</h3>
                                        <div className="time-filters" id="monitor-filters">{['6M','YTD','1Y','2Y','3Y','ALL'].map(p=><button key={p} className={`tf-btn ${config.timeRange===p?'active':''}`} onClick={(e)=>setTimeRange(p, e.target, 'monitor')}>{p}</button>)}</div>
                                    </div>
                                </div>
                                <div className="grid-stats">{Object.keys(monitorResults.res).map((s,i)=><StatsCard key={s} title={s} value={Math.round(monitorResults.res[s].tot).toLocaleString()} sub={`MDD:${Math.round(monitorResults.res[s].mdd)}`} color={['#3182CE','#D69E2E','#38A169'][i%3]}/>)}</div>
                                <div className="chart-box"><h3 style={{marginBottom:10, color:COLORS.text}}>Á≠ñÁï•ÊêçÁõä</h3><MonitorEquityChart data={monitorResults}/></div>
                                <div className="chart-box"><h3 style={{marginBottom:10, color:COLORS.text}}>Á≠ñÁï•ÂõûÊí§</h3><MonitorDDChart data={monitorResults}/></div>
                            </>
                        )}
                        
                        {activeTab === 'intro' && (
                            <div className="intro-container">
                                <InfoCard title="KAMA Cloud" icon={<KamaIcon/>} bg="linear-gradient(135deg, #F5C518, #D69E2E)" concept="KAMA ÂùáÁ∑öÁ∂≤ÁãÄÁµêÊßãÊçïÊçâË∂®Âã¢" logic="ÈÄ≤Â†¥: Â§öÈ†≠ÊéíÂàó + Èõ≤Â∏∂ÈáëÂèâ + ÂãïËÉΩËΩâÂº∑"/>
                                <div style={{height:20}}/>
                                <InfoCard title="Chandelier Exit" icon={<CeoIcon/>} bg="linear-gradient(135deg, #58A6FF, #2D3748)" concept="ATR ÁßªÂãïÊ≠¢Êêç (ÂêäÁáà)" logic="Â§öÂñÆ: ÂÉπÊ†º > Â∫ïÈÉ® + ATR*N"/>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const StatsCard = ({ title, value, sub, color, isNegative }) => (
            <div className="card" style={{borderTop: `4px solid ${color}`}}>
                <h3>{title}</h3>
                <div className={`value ${isNegative ? 'negative' : ''}`} style={{color: isNegative ? COLORS.negative : COLORS.text}}>{value}</div>
                <div className="sub">{sub}</div>
            </div>
        );

        const InfoCard = ({title, icon, bg, concept, logic}) => (
            <div className="info-card">
                <div className="info-card-header"><div className="strat-icon" style={{background: bg}}>{icon}</div><div className="strat-title"><h3>{title}</h3></div></div>
                <div className="info-grid"><div className="info-section"><h4>üí° Ê¶ÇÂøµ</h4><ul className="info-list"><li>{concept}</li></ul></div><div className="info-section"><h4>‚öôÔ∏è ÈÇèËºØ</h4><div className="logic-box">{logic}</div></div></div>
            </div>
        );

        const EquityChart = ({ data, height, config }) => {
            const hasY2 = config.useFixedLev && data.benchKey;
            return <Plot data={[
                { x: data.times, y: data.portCurve, name: 'Portfolio', type: 'scatter', mode: 'lines', line: { color: COLORS.portfolio, width: 2 }, fill: 'tozeroy', fillcolor: 'rgba(214, 158, 46, 0.1)' },
                { x: data.times, y: data.benchCurve, name: 'Benchmark', type: 'scatter', mode: 'lines', line: { color: COLORS.benchmark, width: 1.5 } },
                { x: data.times, y: data.highCurve, name: 'High', type: 'scatter', mode: 'lines', line: { color: COLORS.positive, width: 1, dash: 'dot' }, opacity: 0.6 },
                { x: data.times, y: data.safeCurve, name: 'Safe Level', type: 'scatter', mode: 'lines', line: { color: COLORS.safeLine, width: 1.5, dash: 'dash' }, opacity: 0.8 },
                ...(hasY2 ? [{ x: data.times, y: data.times.map((t,i) => parseFloat(data[i]?.[data.benchKey] || 0)), name: 'Index', yaxis: 'y2', type: 'scatter', mode: 'lines', line: { color: '#CBD5E0', width: 1 }, opacity: 0.5 }] : [])
            ]} layout={{ autosize: true, height: height, margin: { t: 30, l: 40, r: hasY2?50:40, b: 30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: COLORS.subText }, xaxis: { gridcolor: COLORS.border }, yaxis: { title: 'NTD', gridcolor: COLORS.border }, yaxis2: hasY2?{overlaying:'y', side:'right', showgrid:false}:undefined, legend: { orientation: 'h', y: 1.1, x: 0 }, hovermode: 'x unified' }} useResizeHandler={true} style={{width: "100%"}} />;
        };

        const LeverageChart = ({ data, height, config }) => (
            <Plot data={[ { x: data.times, y: data.levCurve, name: 'Leverage', type: 'scatter', mode: 'lines', fill: 'tozeroy', line: { color: '#9C27B0', width: 1.5 }, fillcolor: 'rgba(156, 39, 176, 0.1)' }, ...(config.useFixedLev ? [{ x: [data.times[0], data.times[data.times.length-1]], y: [config.targetLev, config.targetLev], name: 'Target', mode: 'lines', line: { color: '#9C27B0', width: 1, dash: 'dash' } }] : []) ]} layout={{ autosize: true, height: height, margin: { t: 30, l: 40, r: 20, b: 30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: COLORS.subText }, xaxis: { gridcolor: COLORS.border }, yaxis: { title: 'x', gridcolor: COLORS.border }, hovermode: 'x unified', showlegend: false }} useResizeHandler={true} style={{width: "100%"}} />
        );

        const QuarterlyChart = ({ data }) => {
            const keys = Object.keys(data).sort();
            return <Plot data={[ { x: keys, y: keys.map(k => data[k].p), name: 'Port', type: 'bar', marker: { color: COLORS.portfolio } }, { x: keys, y: keys.map(k => data[k].b), name: 'Bench', type: 'bar', marker: { color: COLORS.benchmark, opacity: 0.5 } } ]} layout={{ autosize: true, height: 350, margin: { t: 30, l: 40, r: 20, b: 60 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: COLORS.subText }, xaxis: { gridcolor: COLORS.border, tickangle: -45 }, yaxis: { gridcolor: COLORS.border, title: 'PnL' }, barmode: 'group', legend: { orientation: 'h', y: 1.1 } }} useResizeHandler={true} style={{width: "100%"}} />;
        };

        const DrawdownTable = ({ data }) => (
            <table><thead><tr><th>#</th><th>Peak</th><th>Valley</th><th>End</th><th className="td-num">Loss</th></tr></thead><tbody>{data.map((d, i) => (<tr key={i}><td><span className="rank-badge">{i+1}</span></td><td>{d.start}</td><td>{d.valley}</td><td>{d.end}</td><td className="td-num negative" style={{color:COLORS.negative}}>{Math.round(d.loss).toLocaleString()}</td></tr>))}</tbody></table>
        );

        const MonitorEquityChart = ({ data }) => <Plot data={Object.keys(data.res).map((s, i) => ({ x: data.times, y: data.res[s].cum, name: s, type: 'scatter', mode: 'lines', line: { color: ['#3182CE', '#D69E2E', '#38A169'][i%3], width: 2 } }))} layout={{ autosize: true, height: 400, margin: { t: 30, l: 40, r: 20, b: 30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: COLORS.subText }, xaxis: { gridcolor: COLORS.border }, yaxis: { gridcolor: COLORS.border }, hovermode: 'x unified', legend: { orientation: 'h', y: 1.1 } }} useResizeHandler={true} style={{width: "100%"}} />;
        const MonitorDDChart = ({ data }) => <Plot data={Object.keys(data.res).map((s, i) => ({ x: data.times, y: data.res[s].dd, name: s, type: 'scatter', mode: 'lines', fill: 'tozeroy', line: { color: ['#3182CE', '#D69E2E', '#38A169'][i%3], width: 1 } }))} layout={{ autosize: true, height: 300, margin: { t: 30, l: 40, r: 20, b: 30 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: COLORS.subText }, xaxis: { gridcolor: COLORS.border }, yaxis: { gridcolor: COLORS.border }, hovermode: 'x unified', showlegend: false }} useResizeHandler={true} style={{width: "100%"}} />;

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
